# -*- coding: utf-8 -*-
"""heart disease prediction.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/14dkbDvC8wtX3Z-_ula7J0Cvqs_Tc5s5b
"""

import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.linear_model import LogisticRegression
from sklearn.metrics import accuracy_score, roc_auc_score, classification_report, confusion_matrix, RocCurveDisplay
import xgboost as xgb
import matplotlib.pyplot as plt
import seaborn as sns

df = pd.read_csv("cardio_train.csv")
print(df.head(7))

print("\nMissing values before drop: \n", df.isnull().sum())
print("Shape:", df.shape)

print("Initial data shape:", df.shape)
initial_shape = df.shape
df.replace(["", " ", "NA", "NaN", "nan"], np.nan, inplace=True)
if 'id' in df.columns:
    df.drop(columns=['id'], inplace=True)

# Drop all rows with missing values
before = df.shape[0]
df.dropna(inplace=True)
after = df.shape[0]
print("________________________________________________________")
print("\nMissing values after drop: \n", df.isnull().sum())
print(f"Dropped {before - after} rows. Remaining: {after}")
final_shape = df.shape
print("Shape:", df.shape)
print("\nTarget distribution:\n", df['cardio'].value_counts())
print('________________________________________________________')
print(df['cardio'].value_counts(normalize=True))

# Feature engineering
df['BMI'] = df['weight'] / ((df['height']/100) ** 2)

df.dropna(inplace=True)

features = ['age_yr','ap_hi','ap_lo','cholesterol', 'BMI']
X = df[features].values
y = df['cardio'].values

# Train/test split
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42, stratify=y
)

# Scaling for Logistic Regression
scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)

# Tuned XGBoost
xgb_model = xgb.XGBClassifier()
xgb_model.fit(X_train, y_train)
y_pred_prob_xgb = xgb_model.predict_proba(X_test)[:,1]

# Logistic Regression
logreg = LogisticRegression()
logreg.fit(X_train_scaled, y_train)
y_pred_prob_lr = logreg.predict_proba(X_test_scaled)[:,1]

# Ensemble (weighted average)
y_pred_prob_ensemble = (0.7*y_pred_prob_xgb + 0.3*y_pred_prob_lr)
y_pred_ensemble = (y_pred_prob_ensemble >= 0.5).astype(int)

# Evaluation
print("Ensemble Accuracy:", round(accuracy_score(y_test, y_pred_ensemble),5))
print("Ensemble AUC:", round(roc_auc_score(y_test, y_pred_prob_ensemble),5))
print(classification_report(y_test, y_pred_ensemble))

cm = confusion_matrix(y_test, y_pred_ensemble)
plt.figure(figsize=(6,5))
sns.heatmap(cm, annot=True, fmt='d', cmap='Blues')
plt.title("Confusion Matrix")
plt.xlabel("Predicted")
plt.ylabel("Actual")
plt.show()

from sklearn.metrics import roc_curve, roc_auc_score

try:
    fpr, tpr, _ = roc_curve(y_test, y_pred_prob_ensemble)
    auc = roc_auc_score(y_test, y_pred_prob_ensemble)
except NameError as e:
    raise NameError(
        "Missing variables: make sure 'y_test' and 'y_pred_prob_ensemble' exist in the workspace."
    ) from e

plt.figure(figsize=(8, 6))
plt.plot(fpr, tpr, linewidth=2, label=f'Ensemble (AUC = {auc:.5f})')
plt.plot([0, 1], [0, 1], linestyle='--', linewidth=1, color='grey', label='Random classifier')
plt.fill_between(fpr, tpr, alpha=0.12)

plt.xlim(0.0, 1.0)
plt.ylim(0.0, 1.05)
plt.xlabel('False Positive Rate')
plt.ylabel('True Positive Rate')
plt.title('ROC Curve â€” Cardiovascular Risk Ensemble Model')

# AUC annotation in top-left (axes coordinates)
plt.text(0.02, 0.98, f'AUC = {auc:.5f}', transform=plt.gca().transAxes,
        fontsize=10, verticalalignment='top', bbox=dict(boxstyle="round", fc="white", ec="0.5"))

plt.legend(loc='lower right')
plt.grid(alpha=0.3)
plt.tight_layout()

# display and save
plt.show()

# List of features to plot
features = {
    "BMI": "BMI",
    "Age (Years)": "age_yr",
    "Cholesterol Level": "cholesterol",
}

plt.figure(figsize=(12, 10))

for i, (title, col) in enumerate(features.items(), 1):
    plt.subplot(2, 2, i)
    sns.histplot(df[col], kde=True, bins=30)
    plt.title(f"Distribution of {title}")
    plt.xlabel(title)
    plt.ylabel("Frequency")
    plt.grid(alpha=0.3)

plt.tight_layout()
plt.show()

